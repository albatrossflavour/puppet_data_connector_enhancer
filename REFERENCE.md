# Reference

<!-- DO NOT EDIT: This document was generated by Puppet Strings -->

## Table of Contents

### Classes

#### Public Classes

* [`puppet_data_connector_enhancer`](#puppet_data_connector_enhancer): Manages the Puppet Data Connector Enhancer
* [`puppet_data_connector_enhancer::client`](#puppet_data_connector_enhancer--client): Collect CIS score data for this node from PuppetDB

#### Private Classes

* `puppet_data_connector_enhancer::scm`: Manage SCM CIS score collection and distribution

### Functions

* [`puppet_data_connector_enhancer::parse_csv`](#puppet_data_connector_enhancer--parse_csv): Parse CIS score CSV file into hash of node data.  This function runs on the Puppet master during catalog compilation to parse the CIS summary

## Classes

### <a name="puppet_data_connector_enhancer"></a>`puppet_data_connector_enhancer`

This class manages the installation and configuration of a Ruby script that
enhances the puppet_data_connector module by collecting additional Puppet
infrastructure metrics and pushing them to the data connector dropzone.

The module discovers the dropzone path from the existing puppet_data_connector
configuration to avoid configuration duplication.

#### Examples

##### Basic usage with default parameters

```puppet
include puppet_data_connector_enhancer
```

##### Enable SCM CIS score collection

```puppet
class { 'puppet_data_connector_enhancer':
  enable_scm_collection => true,
  scm_server            => 'scm.example.com',
  scm_auth              => Sensitive(lookup('scm_api_token')),
}
```

##### Custom timeouts and debugging

```puppet
class { 'puppet_data_connector_enhancer':
  http_timeout => 30,
  log_level    => 'DEBUG',
}
```

##### Run every 15 minutes instead of default 30

```puppet
class { 'puppet_data_connector_enhancer':
  timer_interval => '*:0/15',
}
```

##### Configure infrastructure servers for Grafana dashboard filters

```puppet
class { 'puppet_data_connector_enhancer':
  scm_server     => 'gitlab.example.com',
  grafana_server => 'grafana.example.com',
  cd4pe_server   => 'cd4pe.example.com',
}
```

#### Parameters

The following parameters are available in the `puppet_data_connector_enhancer` class:

* [`ensure`](#-puppet_data_connector_enhancer--ensure)
* [`script_path`](#-puppet_data_connector_enhancer--script_path)
* [`http_timeout`](#-puppet_data_connector_enhancer--http_timeout)
* [`http_retries`](#-puppet_data_connector_enhancer--http_retries)
* [`retry_delay`](#-puppet_data_connector_enhancer--retry_delay)
* [`log_level`](#-puppet_data_connector_enhancer--log_level)
* [`timer_ensure`](#-puppet_data_connector_enhancer--timer_ensure)
* [`timer_interval`](#-puppet_data_connector_enhancer--timer_interval)
* [`dropzone`](#-puppet_data_connector_enhancer--dropzone)
* [`output_filename`](#-puppet_data_connector_enhancer--output_filename)
* [`puppet_server`](#-puppet_data_connector_enhancer--puppet_server)
* [`scm_server`](#-puppet_data_connector_enhancer--scm_server)
* [`grafana_server`](#-puppet_data_connector_enhancer--grafana_server)
* [`cd4pe_server`](#-puppet_data_connector_enhancer--cd4pe_server)
* [`enable_scm_collection`](#-puppet_data_connector_enhancer--enable_scm_collection)
* [`scm_auth`](#-puppet_data_connector_enhancer--scm_auth)
* [`scm_dir`](#-puppet_data_connector_enhancer--scm_dir)
* [`scm_export_retention`](#-puppet_data_connector_enhancer--scm_export_retention)
* [`scm_poll_interval`](#-puppet_data_connector_enhancer--scm_poll_interval)
* [`scm_max_wait_time`](#-puppet_data_connector_enhancer--scm_max_wait_time)
* [`scm_timer_interval`](#-puppet_data_connector_enhancer--scm_timer_interval)
* [`scm_log_file`](#-puppet_data_connector_enhancer--scm_log_file)

##### <a name="-puppet_data_connector_enhancer--ensure"></a>`ensure`

Data type: `Enum['present', 'absent']`

Whether the data connector enhancer should be present or absent.

Default value: `'present'`

##### <a name="-puppet_data_connector_enhancer--script_path"></a>`script_path`

Data type: `Optional[Stdlib::Absolutepath]`

The full path where the main metrics collection script will be installed.
Defaults to ${scm_dir}/puppet_data_connector_enhancer.

Default value: `undef`

##### <a name="-puppet_data_connector_enhancer--http_timeout"></a>`http_timeout`

Data type: `Integer[1, 300]`

HTTP request timeout in seconds.

Default value: `5`

##### <a name="-puppet_data_connector_enhancer--http_retries"></a>`http_retries`

Data type: `Integer[1, 10]`

Number of retry attempts for failed HTTP requests.

Default value: `3`

##### <a name="-puppet_data_connector_enhancer--retry_delay"></a>`retry_delay`

Data type: `Numeric`

Initial delay between retry attempts in seconds.

Default value: `2.0`

##### <a name="-puppet_data_connector_enhancer--log_level"></a>`log_level`

Data type: `Enum['DEBUG', 'INFO', 'WARN', 'ERROR']`

The logging level for the script (DEBUG, INFO, WARN, ERROR).

Default value: `'INFO'`

##### <a name="-puppet_data_connector_enhancer--timer_ensure"></a>`timer_ensure`

Data type: `Enum['present', 'absent']`

Whether the systemd timer should be present or absent.

Default value: `'present'`

##### <a name="-puppet_data_connector_enhancer--timer_interval"></a>`timer_interval`

Data type: `String[1]`

The systemd timer interval specification (e.g., '*:0/30' for every 30 minutes).

Default value: `'*:0/30'`

##### <a name="-puppet_data_connector_enhancer--dropzone"></a>`dropzone`

Data type: `Stdlib::Absolutepath`

The path to the dropzone directory. Defaults to the puppet_data_connector configuration.

Default value: `lookup('puppet_data_connector::dropzone', Stdlib::Absolutepath, 'first', '/opt/puppetlabs/puppet/prometheus_dropzone')`

##### <a name="-puppet_data_connector_enhancer--output_filename"></a>`output_filename`

Data type: `String[1]`

The filename for the metrics output (will be placed in the dropzone).

Default value: `'puppet_enhanced_metrics.prom'`

##### <a name="-puppet_data_connector_enhancer--puppet_server"></a>`puppet_server`

Data type: `Optional[Stdlib::Fqdn]`

The Puppet Server hostname (for Grafana dashboard filters).

Default value: `$facts['puppet_server']`

##### <a name="-puppet_data_connector_enhancer--scm_server"></a>`scm_server`

Data type: `Optional[Stdlib::Fqdn]`

The Security Compliance Management (SCM) server hostname. Used for both Grafana dashboard filters and as the SCM API host when enable_scm_collection is true.

Default value: `undef`

##### <a name="-puppet_data_connector_enhancer--grafana_server"></a>`grafana_server`

Data type: `Optional[Stdlib::Fqdn]`

The Grafana server hostname (for Grafana dashboard filters).

Default value: `undef`

##### <a name="-puppet_data_connector_enhancer--cd4pe_server"></a>`cd4pe_server`

Data type: `Optional[Stdlib::Fqdn]`

The Continuous Delivery for PE (CD4PE) server hostname (for Grafana dashboard filters).

Default value: `undef`

##### <a name="-puppet_data_connector_enhancer--enable_scm_collection"></a>`enable_scm_collection`

Data type: `Boolean`

Whether to enable SCM CIS score collection and export functionality.

Default value: `false`

##### <a name="-puppet_data_connector_enhancer--scm_auth"></a>`scm_auth`

Data type: `Optional[Sensitive[String[1]]]`

The SCM API personal access token for authentication. Should not include 'Bearer' prefix (required if enable_scm_collection is true).

Default value: `undef`

##### <a name="-puppet_data_connector_enhancer--scm_dir"></a>`scm_dir`

Data type: `Stdlib::Absolutepath`

Base directory for storing SCM scripts and CSV data. Must be an absolute path.

Default value: `'/opt/puppetlabs/puppet_data_connector_enhancer'`

##### <a name="-puppet_data_connector_enhancer--scm_export_retention"></a>`scm_export_retention`

Data type: `Integer[1]`

Maximum number of API-generated reports to retain on the SCM host. Must be >= 1.

Default value: `8`

##### <a name="-puppet_data_connector_enhancer--scm_poll_interval"></a>`scm_poll_interval`

Data type: `Integer[1]`

Seconds to wait between polling attempts for export completion. Must be >= 1.

Default value: `30`

##### <a name="-puppet_data_connector_enhancer--scm_max_wait_time"></a>`scm_max_wait_time`

Data type: `Integer[1]`

Maximum seconds to wait for export completion before timing out. Must be >= 1.

Default value: `900`

##### <a name="-puppet_data_connector_enhancer--scm_timer_interval"></a>`scm_timer_interval`

Data type: `Pattern[/^.+$/]`

The systemd timer interval specification for SCM exports (e.g., '*:0/30' for every 30 minutes).

Default value: `'*:0/30'`

##### <a name="-puppet_data_connector_enhancer--scm_log_file"></a>`scm_log_file`

Data type: `Stdlib::Absolutepath`

The path to the SCM export script log file.

Default value: `'/var/log/puppetlabs/puppet_data_connector_enhancer_scm.log'`

### <a name="puppet_data_connector_enhancer--client"></a>`puppet_data_connector_enhancer::client`

This private class runs on all managed nodes when SCM collection is enabled.
It collects the exported file resource containing this node's CIS score data from PuppetDB.
The resource is written to the OS-appropriate external facts directory where Facter
automatically loads it as the 'cis_score' structured fact on the next Puppet run.

The fact will contain:
  - scan_timestamp: ISO 8601 timestamp of the scan
  - scan_type: Type of scan (e.g., "ad hoc")
  - scanned_benchmark: CIS benchmark name and version
  - scanned_profile: Profile applied (e.g., "Level 1 - Server")
  - adjusted_compliance_score: Score after exceptions
  - exception_score: Score with exceptions included

## Functions

### <a name="puppet_data_connector_enhancer--parse_csv"></a>`puppet_data_connector_enhancer::parse_csv`

Type: Ruby 4.x API

Parse CIS score CSV file into hash of node data.

This function runs on the Puppet master during catalog compilation to parse
the CIS summary CSV file downloaded from SCM. It returns a hash keyed by
certname (lowercased) containing each node's CIS score data.

#### Examples

##### Parse CSV file

```puppet
$scores = puppet_data_connector_enhancer::parse_csv('/opt/puppetlabs/puppet_data_connector_enhancer/score_data/Summary_Report_API.csv')
# => {
#      'node1.example.com' => {
#        'scan_timestamp' => '2025-09-09T00:17:43Z',
#        'scan_type' => 'ad hoc',
#        'scanned_benchmark' => '2.0.0 CIS Ubuntu Linux 22.04 LTS',
#        'scanned_profile' => 'Level 1 - Server',
#        'adjusted_compliance_score' => '84',
#        'exception_score' => '84'
#      }
#    }
```

#### `puppet_data_connector_enhancer::parse_csv(String $csv_path)`

Parse CIS score CSV file into hash of node data.

This function runs on the Puppet master during catalog compilation to parse
the CIS summary CSV file downloaded from SCM. It returns a hash keyed by
certname (lowercased) containing each node's CIS score data.

Returns: `Any` Hash of certname => score data, or empty hash if file doesn't exist

##### Examples

###### Parse CSV file

```puppet
$scores = puppet_data_connector_enhancer::parse_csv('/opt/puppetlabs/puppet_data_connector_enhancer/score_data/Summary_Report_API.csv')
# => {
#      'node1.example.com' => {
#        'scan_timestamp' => '2025-09-09T00:17:43Z',
#        'scan_type' => 'ad hoc',
#        'scanned_benchmark' => '2.0.0 CIS Ubuntu Linux 22.04 LTS',
#        'scanned_profile' => 'Level 1 - Server',
#        'adjusted_compliance_score' => '84',
#        'exception_score' => '84'
#      }
#    }
```

##### `csv_path`

Data type: `String`

Absolute path to the CSV file on the master

